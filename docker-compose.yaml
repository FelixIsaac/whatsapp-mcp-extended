services:
  whatsapp-bridge:
    build:
      context: .
      dockerfile: Dockerfile.bridge
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
    ports:
      - "127.0.0.1:8180:8080"  # Localhost only for security
    volumes:
      - ./store:/app/whatsapp-bridge/store
    environment:
      - TZ=UTC
      - API_KEY=${API_KEY:?API_KEY is required - see .env.example}
      - DISABLE_AUTH_CHECK=${DISABLE_AUTH_CHECK:-false}
    restart: unless-stopped
    networks:
      - whatsapp_internal

  whatsapp-mcp:
    build:
      context: .
      dockerfile: Dockerfile.mcp
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1'
    ports:
      - "127.0.0.1:8081:8081"  # MCP server (localhost only)
      - "127.0.0.1:8082:8082"  # Gradio UI (localhost only)
    volumes:
      - ./store:/app/store
    environment:
      - TZ=UTC
      - DEBUG=true
      - GRADIO=false
      - BRIDGE_HOST=whatsapp-mcp-whatsapp-bridge-1
      - API_KEY=${API_KEY}
    depends_on:
      - whatsapp-bridge
    restart: unless-stopped
    networks:
      - n8n_n8n_traefik_network
      - whatsapp_internal

  webhook-ui:
    build:
      context: .
      dockerfile: Dockerfile.ui
    deploy:
      resources:
        limits:
          memory: 500M
          cpus: '0.5'
    ports:
      - "127.0.0.1:8089:8080"  # Webhook UI (localhost only)
    depends_on:
      - whatsapp-bridge
      - whatsapp-mcp
    restart: unless-stopped
    networks:
      - whatsapp_internal

networks:
  n8n_n8n_traefik_network:
    external: true
  whatsapp_internal:
    driver: bridge
