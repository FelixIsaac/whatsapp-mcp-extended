services:
  whatsapp-bridge:
    build:
      context: .
      dockerfile: Dockerfile.bridge
      args:
        UID: ${UID:-1000}
        GID: ${GID:-1000}
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
    dns:
      - 8.8.8.8
      - 8.8.4.4
    ports:
      - "0.0.0.0:8180:8080"  # Localhost only for security
    volumes:
      - ./store:/app/whatsapp-bridge/store
    environment:
      - TZ=UTC
      - API_KEY=${API_KEY:?API_KEY is required - see .env.example}
      - DISABLE_AUTH_CHECK=${DISABLE_AUTH_CHECK:-false}
    restart: unless-stopped
    networks:
      - whatsapp_internal

  whatsapp-mcp:
    build:
      context: .
      dockerfile: Dockerfile.mcp
      args:
        UID: ${UID:-1000}
        GID: ${GID:-1000}
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1'
    ports:
      - "127.0.0.1:8081:8081"  # MCP server (localhost only)
      - "127.0.0.1:8082:8082"  # Gradio UI (localhost only)
    volumes:
      - ./store:/app/store
    environment:
      - TZ=UTC
      - DEBUG=true
      - GRADIO=false
      - BRIDGE_HOST=whatsapp-bridge
      - API_KEY=${API_KEY}
    depends_on:
      - whatsapp-bridge
    restart: unless-stopped
    networks:
      - n8n_n8n_traefik_network
      - whatsapp_internal

  # Legacy webhook-ui - deprecated, use web-ui instead
  # webhook-ui:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile.ui
  #   ports:
  #     - "127.0.0.1:8089:8080"

  web-ui:
    build:
      context: .
      dockerfile: Dockerfile.web-ui
    deploy:
      resources:
        limits:
          memory: 300M
          cpus: '0.5'
    ports:
      - "0.0.0.0:8090:8080"  # Unified Web UI (pairing + webhooks)
    depends_on:
      - whatsapp-bridge
    restart: unless-stopped
    networks:
      - whatsapp_internal

networks:
  n8n_n8n_traefik_network:
    external: true
  whatsapp_internal:
    driver: bridge
